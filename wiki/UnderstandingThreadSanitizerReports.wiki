#summary How to understand the reports produced by ThreadSanitizer

=THIS PAGE IS UNDER CONSTRUCTION=
<wiki:toc max_depth="1" />

=Simple example=

Let's consider the simplest example, test301 from RacecheckUnittest.
{{{
Mutex mu1;  // This Mutex guards var.
Mutex mu2;  // This Mutex is not related to var.
int   var;  // GUARDED_BY(mu1)

void Thread1() {  // Runs in thread named 'test-thread-1'.
  MutexLock lock(&mu1);  // Correct Mutex.
  var = 1; 
}

void Thread2() {  // Runs in thread named 'test-thread-2'.
  MutexLock lock(&mu2);  // Wrong Mutex.
  var = 2; 
}
}}}

You can run !ThreadSanitizer like this: 
{{{
valgrind --tool=tsan ./racecheck_unittest 301
}}}

The report (printed to stderr) will look like this:
{{{
==30360== INFO: T1 has been created by T0. Use --announce-threads to see the creation stack.
==30360== INFO: T2 has been created by T0. Use --announce-threads to see the creation stack.
==30360== WARNING: Possible data race during write of size 4 at 0x633AA0: {{{
==30360==    T2 (test-thread-2) (locks held: {L122}):
==30360==     #0  test301::Thread2() racecheck_unittest.cc:5956
==30360==     #1  MyThread::ThreadBody(MyThread*) thread_wrappers_pthread.h:320
==30360==     #2  ThreadSanitizerStartThread ts_valgrind_intercepts.c:387
==30360==   Concurrent write(s) happened at (OR AFTER) these points:
==30360==    T1 (test-thread-1) (locks held: {L121}):
==30360==     #0  test301::Thread1() racecheck_unittest.cc:5951
==30360==     #1  MyThread::ThreadBody(MyThread*) thread_wrappers_pthread.h:320
==30360==     #2  ThreadSanitizerStartThread ts_valgrind_intercepts.c:387
==30360==   Address 0x633AA0 is 0 bytes inside data symbol "_ZN7test3013varE"
==30360==   Locks involved in this report (reporting last lock sites): {L121, L122}
==30360==    L121 (0x633A10)
==30360==     #0  pthread_mutex_lock ts_valgrind_intercepts.c:602
==30360==     #1  Mutex::Lock() thread_wrappers_pthread.h:162
==30360==     #2  MutexLock::MutexLock(Mutex*) thread_wrappers_pthread.h:225
==30360==     #3  test301::Thread1() racecheck_unittest.cc:5950
==30360==     #4  MyThread::ThreadBody(MyThread*) thread_wrappers_pthread.h:320
==30360==     #5  ThreadSanitizerStartThread ts_valgrind_intercepts.c:387
==30360==    L122 (0x633A70)
==30360==     #0  pthread_mutex_lock ts_valgrind_intercepts.c:602
==30360==     #1  Mutex::Lock() thread_wrappers_pthread.h:162
==30360==     #2  MutexLock::MutexLock(Mutex*) thread_wrappers_pthread.h:225
==30360==     #3  test301::Thread2() racecheck_unittest.cc:5955
==30360==     #4  MyThread::ThreadBody(MyThread*) thread_wrappers_pthread.h:320
==30360==     #5  ThreadSanitizerStartThread ts_valgrind_intercepts.c:387
==30360== }}}
}}}

You can view this report together with the sources using your favourite editor. 
Here is an example using ThreadSanitizerAndVim: 
the window at left shows the !ThreadSanitizer's output, the two windows at right 
display the two racey accesses.

 http://data-race-test.googlecode.com/svn/trunk/images/tsan-in-vim-three-windows.png

Let us now describe each section of the report.

{{{
==30360== INFO: T1 has been created by T0. Use --announce-threads to see the creation stack.
==30360== INFO: T2 has been created by T0. Use --announce-threads to see the creation stack.
}}}
Each race report mentions two or more threads, e.g. `T1` and `T2`. 
Note that the main thread of the program is called `T0`. Each thread is announced only once. 
If you use the flag `--announce-threads` you will get the context where this thread hasbeen created.

{{{
==30360== WARNING: Possible data race during write of size 4 at 0x633AA0: {{{
}}}

This is the header of the report. 
It mentiones the address of the racey memory, the size of the racey access and whether it was a read or a write.


{{{
==30360==    T2 (test-thread-2) (locks held: {L122}):
}}}
This is the infoamtion about the last observed access which is considered to be racey. 
  * `T2` is the thread where this access happened.
  * `test-thread-2` is the name of the thread. The threads are named using `ANNOTATE_THREAD_NAME(name)` from DynamicAnotations.
  * `(locks held: {L122})`: this is a list of all locks held during this access. 
     If some locks are held in reader mode, the reader and writer locks will be shown separately. 

{{{
==30360==     #0  test301::Thread2() racecheck_unittest.cc:5956
==30360==     #1  MyThread::ThreadBody(MyThread*) thread_wrappers_pthread.h:320
==30360==     #2  ThreadSanitizerStartThread ts_valgrind_intercepts.c:387
}}}
And here is the exact stack trace of the last observed access.

{{{
==30360==   Concurrent write(s) happened at (OR AFTER) these points:
}}}

{{{
==30360==    T1 (test-thread-1) (locks held: {L121}):
==30360==     #0  test301::Thread1() racecheck_unittest.cc:5951
==30360==     #1  MyThread::ThreadBody(MyThread*) thread_wrappers_pthread.h:320
==30360==     #2  ThreadSanitizerStartThread ts_valgrind_intercepts.c:387
==30360==   Address 0x633AA0 is 0 bytes inside data symbol "_ZN7test3013varE"
==30360==   Locks involved in this report (reporting last lock sites): {L121, L122}
==30360==    L121 (0x633A10)
==30360==     #0  pthread_mutex_lock ts_valgrind_intercepts.c:602
==30360==     #1  Mutex::Lock() thread_wrappers_pthread.h:162
==30360==     #2  MutexLock::MutexLock(Mutex*) thread_wrappers_pthread.h:225
==30360==     #3  test301::Thread1() racecheck_unittest.cc:5950
==30360==     #4  MyThread::ThreadBody(MyThread*) thread_wrappers_pthread.h:320
==30360==     #5  ThreadSanitizerStartThread ts_valgrind_intercepts.c:387
==30360==    L122 (0x633A70)
==30360==     #0  pthread_mutex_lock ts_valgrind_intercepts.c:602
==30360==     #1  Mutex::Lock() thread_wrappers_pthread.h:162
==30360==     #2  MutexLock::MutexLock(Mutex*) thread_wrappers_pthread.h:225
==30360==     #3  test301::Thread2() racecheck_unittest.cc:5955
==30360==     #4  MyThread::ThreadBody(MyThread*) thread_wrappers_pthread.h:320
==30360==     #5  ThreadSanitizerStartThread ts_valgrind_intercepts.c:387
==30360== }}}
}}}

